<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="description"
      content="Read budgeting stories inside the My Super Calculators website."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Story Viewer – My Super Calculators</title>
    <link rel="stylesheet" href="../css/base.css" />

    <style>
      /* Local styling just for this viewer */

      .story-hero {
        background: linear-gradient(to right, #1f2937, #111827);
        color: #e5e7eb;
        border-radius: 18px 18px 12px 12px;
        padding: 0.9rem 1.2rem 1rem;
        margin: -0.1rem -0.2rem 1rem -0.2rem;
      }

      .story-hero p,
      .story-hero h2 {
        color: #e5e7eb;
        margin-bottom: 0.35rem;
      }

      .story-hero h2 {
        font-size: 1.3rem;
      }

      .story-hero .item-card-meta {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to main content</a>

    <header>
      <nav class="nav" aria-label="Primary">
        <a href="../index.html" class="nav-brand">My Super Calculators</a>
        <div class="nav-links">
          <a href="../index.html">Home</a>
          <a href="../calculators.html">Calculators</a>
          <a href="../stories.html" aria-current="page">Stories</a>
        </div>
      </nav>
    </header>

    <!-- Screen-reader-only live region for error messages -->
    <div
      id="global-status"
      aria-live="polite"
      style="
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      "
    ></div>

    <main id="main">
      <section aria-labelledby="story-title">
        <article class="card">
          <div class="story-hero">
            <p class="item-card-meta" id="story-category">
              <!-- Category name will be inserted here -->
            </p>
            <h2 id="story-title">Loading story…</h2>
            <p class="item-card-meta" id="story-subtitle"></p>
            <p class="item-card-body" id="story-description"></p>
          </div>

          <div
            id="story-frame-wrapper"
            style="
              margin-top: 0.25rem;
              border-radius: 10px;
              overflow: hidden;
              border: 1px solid var(--border);
              background: #ffffff;
              height: 70vh;
            "
          >
            <iframe
              id="story-frame"
              title="Story content"
              style="width: 100%; height: 100%; border: none;"
            ></iframe>
          </div>

          <p
            class="item-card-meta"
            id="story-download"
            style="margin-top: 0.75rem;"
          >
            <a id="story-download-link" href="#" download>
              Download this story as a PDF
            </a>
          </p>

          <p class="item-card-meta" id="story-status" aria-live="polite"></p>
        </article>
      </section>
    </main>

    <footer>
      <p>
        These tools and stories are provided for general information and
        entertainment purposes only and do not constitute financial, legal, or
        tax advice. We are not a fiduciary and do not make recommendations based
        on your personal financial situation. Please consult a qualified
        professional for advice tailored to your needs.
      </p>
    </footer>

    <script src="../js/utils.js"></script>
    <script>
      (function () {
        "use strict";

        const searchParams = new URLSearchParams(window.location.search);
        const categoryParam = searchParams.get("category");
        const storyParam = searchParams.get("story");

        const titleEl = document.getElementById("story-title");
        const subtitleEl = document.getElementById("story-subtitle");
        const descEl = document.getElementById("story-description");
        const categoryEl = document.getElementById("story-category");
        const frameEl = document.getElementById("story-frame");
        const frameWrapperEl = document.getElementById("story-frame-wrapper");
        const downloadLinkEl = document.getElementById("story-download-link");
        const statusEl = document.getElementById("story-status");
        const globalStatusEl = document.getElementById("global-status");

        function setStatus(message) {
          if (statusEl) statusEl.textContent = message || "";
          if (globalStatusEl) globalStatusEl.textContent = message || "";
        }

        function showError(message) {
          titleEl.textContent = "Story not available";
          subtitleEl.textContent = "";
          descEl.textContent = "";
          categoryEl.textContent = "";
          frameWrapperEl.style.display = "none";
          downloadLinkEl.style.display = "none";
          setStatus(
            message ||
              "We couldn't load this story. Please return to the stories list and try again."
          );
        }

        if (!categoryParam || !storyParam) {
          showError(
            "We couldn't find the requested story. Please return to the stories list and try again."
          );
          return;
        }

        fetch("../assets/data/stories.json")
          .then(function (response) {
            if (!response.ok) {
              throw new Error("Failed to load stories metadata.");
            }
            return response.json();
          })
          .then(function (data) {
            const category = data[categoryParam];

            if (!category || !Array.isArray(category.stories)) {
              showError(
                "This story category could not be found. Please return to the stories list."
              );
              return;
            }

            const story = category.stories.find(function (s) {
              return s.id === storyParam;
            });

            if (!story) {
              showError(
                "The requested story could not be found. It may have been removed or renamed."
              );
              return;
            }

            document.title =
              (story.title || "Story") + " – My Super Calculators";

            categoryEl.textContent = category.label
              ? "Category: " + category.label
              : "";
            titleEl.textContent = story.title || "Untitled story";
            subtitleEl.textContent = story.subtitle || "";
            descEl.textContent = story.description || "";

            if (story.pdf) {
              frameWrapperEl.style.display = "block";
              frameEl.src = story.pdf;
              downloadLinkEl.href = story.pdf;

              if (story.title) {
                const safeName = story.title
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, "-")
                  .replace(/^-+|-+$/g, "");
                downloadLinkEl.setAttribute("download", safeName + ".pdf");
              }

              setStatus("");
            } else {
              frameWrapperEl.style.display = "none";
              downloadLinkEl.style.display = "none";
              setStatus(
                "This story is missing its PDF file. Please check back later."
              );
            }
          })
          .catch(function (err) {
            console.error(err);
            showError(
              "There was a problem loading this story. Please try again later."
            );
          });
      })();
    </script>
  </body>
</html>
